{% extends 'views/base/base.nunjucks' %}

{% block title %} - 我点过的赞{% endblock %}

{% block head_res %}
    <script src="/js/lib/cookie.js"></script>
    <script src="/lib/vue/vue.js"></script>
{% endblock %}

{% block body %}

    <style>
        .like-root-div{ width: 80%;padding: 16px 10%;display: flex;flex-direction: column;justify-content: center;align-items: center; }
        .like-title{ font-weight: 300;font-size: 48px;width: 100%;margin-left: 2em; }
        .like-items-root-div{ display: flex;flex-direction: column;width: 100%;align-items: flex-start;justify-content: center;background: white;border-radius: 36px;padding: 26px 0;box-shadow: lightgray 0 0 12px; }
        .like-items-div{ display: flex;flex-direction: row;justify-content: space-between;align-items: center;width: 90%;padding: 16px 5%;background: none;transition: 0.3s;cursor: pointer; }
        .like-items-div:hover{ display: flex;flex-direction: row;justify-content: space-between;align-items: center;width: 90%;padding: 16px 5%;background: #e0e0e0;transition: 0.3s;cursor: pointer; }
        .like-items-thumbnail{ width: auto; height: 82px;border-radius: 8px;margin-right: 16px; }
        .like-items-text-content{ flex: 1;display: flex;flex-direction: column; }
        .like-items-title{ color: #333333;font-size: 16px; }
        .like-items-date{ color: gray;font-size: 14px; }
        .like-hint-text{ margin: 24px 0;line-height: 2em;text-align: center; }
        .like-load-more{ background: white;border-radius: 1000px;padding: 8px 32px;border: #03CC01 solid 1px;outline: none;cursor: pointer;font-size: 16px;font-weight: 300;color: #03CC01;align-self: center;margin-top: 16px;transition: 0.3s; }
        .like-load-more:hover{ background: #03CC01;border-radius: 1000px;padding: 8px 32px;border: white solid 1px;outline: none;cursor: pointer;font-size: 16px;font-weight: 300;color: white;align-self: center;margin-top: 16px;transition: 0.3s; }

        @media (max-width: 767px) {
            .like-root-div{ width: 100%;padding: 16px 0;display: flex;flex-direction: column;justify-content: center;align-items: center; }
            .like-items-root-div{ display: flex;flex-direction: column;width: 100%;align-items: flex-start;justify-content: center;background: white;border-radius: 0;padding: 26px 0;box-shadow: lightgray 0 0 12px; }
        }
    </style>

    <div class="like-root-div" id="likeApp">
        <p class="like-title"><img onclick="history.back()" src="/icon/ic_back_gray.png" style="height: 0.75em;margin-right: 16px;"/>我的点赞</p>
        <div class="like-items-root-div" id="likeItemListDiv">
            <div class="like-items-div" v-for="(tmpLike, index) in likeDateList" v-on:click="onItemClick(tmpLike)">
                <img class="like-items-thumbnail" v-bind:src="tmpLike.image_thumbnail" />
                <div class="like-items-text-content">
                    <span class="like-items-title">{% raw %}{{ tmpLike.title }}{% endraw %}</span>
                    <span class="like-items-date">{% raw %}{{ tmpLike.date }}{% endraw %}</span>
                </div>
            </div>

            <button class="like-load-more" id="likeLoadMore" v-on:click="loadMoreImage()">加载更多</button>
        </div>

        <span class="like-hint-text" id="likeHintText">还没有点过赞哦😯</span>

        <img id="likeProgressBar" src="/icon/ic_loading_gray.gif" style="height: 36px;width: 36px;margin: 16px 0;"/>

    </div>

    <script>
        const STATE_DISABLE = 1;
        const STATE_LOADING = 2;
        const STATE_EMPTY = 3;
        const STATE_LOAD_IDLE = 4;
        const STATE_LOAD_FINISH = 5;
        const STATE_LOAD_FAIL = 6;

        function setLikeListState(state) {
            const likeListItemDiv = document.getElementById('likeItemListDiv');
            const likeHintTextSpan = document.getElementById('likeHintText');
            const likeLoadMoreButton = document.getElementById('likeLoadMore');
            const likeProgressBar = document.getElementById('likeProgressBar');
            switch (state) {
                case STATE_DISABLE:
                    likeListItemDiv.style.display = 'none';
                    likeHintTextSpan.style.display = 'flex';
                    likeLoadMoreButton.style.display = 'none';
                    likeProgressBar.style.display = 'none';
                    likeHintTextSpan.innerHTML = '点赞功能关闭了😯<br>你可以前往“<a href=\'/me/\'>我</a>”页面重新打开';
                    break;
                case STATE_LOADING:
                    likeListItemDiv.style.display = 'flex';
                    likeHintTextSpan.style.display = 'none';
                    likeLoadMoreButton.style.display = 'none';
                    likeProgressBar.style.display = 'box';
                    likeHintTextSpan.innerHTML = '加载中';
                    break;
                case STATE_EMPTY:
                    likeListItemDiv.style.display = 'none';
                    likeHintTextSpan.style.display = 'flex';
                    likeLoadMoreButton.style.display = 'none';
                    likeProgressBar.style.display = 'none';
                    likeHintTextSpan.innerHTML = '还没有点过赞哦';
                    break;
                case STATE_LOAD_IDLE:
                    likeListItemDiv.style.display = 'flex';
                    likeHintTextSpan.style.display = 'none';
                    likeLoadMoreButton.style.display = 'flex';
                    likeProgressBar.style.display = 'none';
                    break;
                case STATE_LOAD_FINISH:
                    likeListItemDiv.style.display = 'flex';
                    likeHintTextSpan.style.display = 'none';
                    likeLoadMoreButton.style.display = 'none';
                    likeProgressBar.style.display = 'none';
                    break;
                case STATE_LOAD_FAIL:
                    likeListItemDiv.style.display = 'flex';
                    likeHintTextSpan.style.display = 'flex';
                    likeLoadMoreButton.style.display = 'flex';
                    likeProgressBar.style.display = 'none';
                    likeHintTextSpan.innerHTML = '刷新失败了 ❌';
                    break;
            }
        }

        var likeApp = new Vue({
            el : '#likeApp',
            data : {
                LOAD_SIZE : 3,

                likeDateList : [], // 应该至包含少以下几个信息 title:名称 date:日期 image_thumbnail:缩略图
                likeDateRawList : [],
                currentLoadPos : 0,
            },
            mounted : function () {
                const self = this;
                // self.refreshLikeState();
                self.likeDateRawList = self.getLikeJsonArray();
                self.loadMoreImage()
            },
            methods : {
                refreshLikeState() {
                    const self = this;
                    if (isLikeEnabledCookie()){
                        const tmpLikeRawList = getLikesCookie();
                        if (tmpLikeRawList.length > 0){
                            setLikeListState(STATE_LOADING);
                        } else{ // 没有点过赞
                            setLikeListState(STATE_EMPTY);
                        }
                    } else { // 关闭了点赞
                        setLikeListState(STATE_DISABLE);
                    }
                },
                getLikeJsonArray(){
                    let tmpResult = [];
                    getLikesCookie().forEach((value,index,array) => {
                        if (value.length === 8){
                            tmpResult.push(value)
                        }
                    });
                    return tmpResult;
                },
                loadMoreImage(){
                    const self = this;
                    setLikeListState(STATE_LOADING);
                    // TODO:发送请求
                    let tmpLoadSize = 0;
                    if (self.currentLoadPos >= self.likeDateRawList.length){ // 已经加载完了
                        tmpLoadSize = 0;
                        setLikeListState(STATE_LOAD_FINISH);
                    } else if( self.likeDateRawList.length - self.currentLoadPos > self.LOAD_SIZE ) { // 还有超过SIZE条要加载，也就是说这次加载SIZE条
                        tmpLoadSize = self.LOAD_SIZE;
                        setLikeListState(STATE_LOAD_IDLE);
                    } else { // 还有不到SIZE条需要加载
                        tmpLoadSize = self.likeDateRawList.length - self.currentLoadPos;
                        setLikeListState(STATE_LOAD_FINISH);
                    }
                    for (let i=0;i<tmpLoadSize;i++){
                        const tmpDate = self.likeDateRawList[self.currentLoadPos+i];
                        const tmpYear = tmpDate.substring(0,4);
                        const tmpMonth = tmpDate.substring(4,6);
                        const tmpDay = tmpDate.substring(6,8);
                        self.likeDateList.push({
                            title : '名称'+(self.currentLoadPos+i),
                            date : tmpDate,
                            image_thumbnail : '/bing-image/'+tmpYear+'/'+tmpMonth+'/'+tmpDay+'/400x240.jpg'
                        })
                    }
                    self.currentLoadPos += tmpLoadSize;
                },
                onItemClick(image){
                    window.open('/view/'+image.date)
                }

            }
        });

        console.log(document.cookie)

    </script>
{% endblock %}
